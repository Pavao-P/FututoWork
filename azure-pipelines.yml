# azure-pipelines.yml
trigger: none
pr: none

variables:
  ACR_NAME: 'acrfuturowork' # sobrescrever na Library ou Variables do pipeline
  RG_NAME: 'rg-futurowork'  # sobrescrever
  CONTAINERAPPS_ENV_NAME: 'env-futurowork'
  CONTAINERAPP_BACKEND_NAME: 'ca-backend-futurowork'
  CONTAINERAPP_FRONTEND_NAME: 'ca-frontend-futurowork'
  IMAGE_BACKEND_TAG: 'backend:$(Build.BuildId)'
  IMAGE_FRONTEND_TAG: 'frontend:$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build and Push Images'
    jobs:
      - job: build
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "Building backend..."
              cd futurowork-backend
              ./mvnw -B -DskipTests package
            displayName: 'Maven build backend'
          - script: |
              echo "Building frontend..."
              cd futurowork-frontend
              npm install
              npm run build
            displayName: 'Build frontend'
          - task: AzureCLI@2
            displayName: 'ACR: build and push images'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -e
                LOGIN_SERVER=$(az acr show -n $(ACR_NAME) -g $(RG_NAME) --query loginServer -o tsv)
                echo "Login server: $LOGIN_SERVER"
                cd futurowork-backend
                az acr build --registry $(ACR_NAME) --image $(IMAGE_BACKEND_TAG) .
                cd ../futurowork-frontend
                az acr build --registry $(ACR_NAME) --image $(IMAGE_FRONTEND_TAG) .
          - publish: futurowork-backend/target
            artifact: backend
          - publish: futurowork-frontend/dist
            artifact: frontend

  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        environment: 'futurowork-env'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Create/Update Container Apps'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      set -e
                      LOGIN_SERVER=$(az acr show -n $(ACR_NAME) -g $(RG_NAME) --query loginServer -o tsv)
                      BACKEND_IMAGE="$LOGIN_SERVER/$(IMAGE_BACKEND_TAG)"
                      FRONTEND_IMAGE="$LOGIN_SERVER/$(IMAGE_FRONTEND_TAG)"
                      echo "Backend image: $BACKEND_IMAGE"
                      echo "Frontend image: $FRONTEND_IMAGE"
                      az containerapp create -g $(RG_NAME) -n $(CONTAINERAPP_BACKEND_NAME) --environment $(CONTAINERAPPS_ENV_NAME) --image $BACKEND_IMAGE --registry-server $LOGIN_SERVER --ingress internal --target-port 8080 || az containerapp update -g $(RG_NAME) -n $(CONTAINERAPP_BACKEND_NAME) --image $BACKEND_IMAGE
                      az containerapp create -g $(RG_NAME) -n $(CONTAINERAPP_FRONTEND_NAME) --environment $(CONTAINERAPPS_ENV_NAME) --image $FRONTEND_IMAGE --registry-server $LOGIN_SERVER --ingress external --target-port 80 || az containerapp update -g $(RG_NAME) -n $(CONTAINERAPP_FRONTEND_NAME) --image $FRONTEND_IMAGE
